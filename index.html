<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz med OpenRouter API</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      color: #102a43;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      min-height: 100vh;
      margin: 0;
    }
    h1 {
      margin-bottom: 0.5rem;
    }
    #question {
      font-size: 1.4rem;
      margin: 1rem 0;
      min-height: 4em;
      max-width: 600px;
      text-align: center;
    }
    #answer-input {
      font-size: 1.2rem;
      padding: 0.5rem;
      width: 300px;
      max-width: 90vw;
      border: 2px solid #627d98;
      border-radius: 6px;
      outline: none;
      transition: border-color 0.3s;
    }
    #answer-input:focus {
      border-color: #2cb67d;
    }
    button {
      margin-top: 1rem;
      background-color: #2cb67d;
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      font-size: 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover:not(:disabled) {
      background-color: #249a67;
    }
    button:disabled {
      background-color: #a0c4a6;
      cursor: not-allowed;
    }
    #feedback {
      margin-top: 1rem;
      font-size: 1.1rem;
      min-height: 1.5em;
      color: #334e68;
      transition: opacity 0.4s;
    }
    #score {
      margin-top: 1rem;
      font-weight: bold;
      font-size: 1.2rem;
    }
    #loading {
      margin-top: 1rem;
      font-style: italic;
      color: #627d98;
    }
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    .fade-in {
      animation: fadeIn 0.6s ease-in-out;
    }
  </style>
</head>
<body>
  <h1>Quiz med OpenRouter API</h1>
  <div id="question" class="fade-in">Tryck p친 Start f칬r att f친 din f칬rsta fr친ga!</div>
  <input type="text" id="answer-input" placeholder="Skriv ditt svar h칛r..." disabled />
  <button id="submit-btn" disabled>Skicka svar</button>
  <button id="start-btn">Starta quiz</button>
  <div id="feedback"></div>
  <div id="score">Po칛ng: 0</div>
  <div id="loading" style="display:none;">Laddar fr친ga...</div>

  <script>
    const questionEl = document.getElementById('question');
    const answerInput = document.getElementById('answer-input');
    const submitBtn = document.getElementById('submit-btn');
    const startBtn = document.getElementById('start-btn');
    const feedbackEl = document.getElementById('feedback');
    const scoreEl = document.getElementById('score');
    const loadingEl = document.getElementById('loading');

    let currentQuestion = '';
    let currentAnswer = '';
    let score = 0;
    let isWaitingForAnswer = false;

    startBtn.addEventListener('click', () => {
      score = 0;
      updateScore();
      startBtn.disabled = true;
      answerInput.disabled = false;
      submitBtn.disabled = false;
      feedbackEl.textContent = '';
      loadNewQuestion();
      answerInput.focus();
    });

    submitBtn.addEventListener('click', () => {
      if (isWaitingForAnswer) return; // prevent double submit
      const userAnswer = answerInput.value.trim();
      if (!userAnswer) return;
      checkAnswer(userAnswer);
    });

    answerInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' && !submitBtn.disabled) {
        submitBtn.click();
      }
    });

    function updateScore() {
      scoreEl.textContent = `Po칛ng: ${score}`;
    }

    async function loadNewQuestion() {
      loadingEl.style.display = 'block';
      feedbackEl.textContent = '';
      answerInput.value = '';
      answerInput.disabled = true;
      submitBtn.disabled = true;
      currentQuestion = '';
      currentAnswer = '';
      isWaitingForAnswer = true;

      try {
        // Skicka fr친ga till proxyfunktionen som skickar vidare till OpenRouter API
        const prompt = "Ge mig en enkel allm칛nkunskapsfr친ga och dess svar p친 svenska i formatet: fr친ga: ... svar: ...";

        const response = await fetch('/.netlify/functions/openrouter-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: "openai/gpt-4o-mini",
            messages: [{ role: "user", content: prompt }],
            max_tokens: 100,
          }),
        });

        if (!response.ok) {
          throw new Error('N친got gick fel vid h칛mtning av fr친ga');
        }

        const data = await response.json();
        // OpenRouter brukar returnera ett svar i data.choices[0].message.content
        let text = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;

        if (!text) throw new Error('Inget svar fr친n API');

        // Parsar fr친ga och svar fr친n texten
        // F칬rv칛ntat format: "fr친ga: ... svar: ..."
        const match = text.match(/fr친ga:\s*(.+)\s+svar:\s*(.+)/i);
        if (match && match.length === 3) {
          currentQuestion = match[1].trim();
          currentAnswer = match[2].trim().toLowerCase();
        } else {
          // Om formatet inte st칛mmer, visa hela texten som fr친ga och f칬rv칛nta att svar blir korrekt
          currentQuestion = text.trim();
          currentAnswer = ''; // ok칛nt svar
        }

        questionEl.textContent = currentQuestion;
        questionEl.classList.add('fade-in');
        answerInput.disabled = false;
        submitBtn.disabled = false;
        answerInput.focus();
      } catch (e) {
        questionEl.textContent = "Kunde inte h칛mta fr친ga, prova igen senare.";
        answerInput.disabled = true;
        submitBtn.disabled = true;
        console.error(e);
      } finally {
        loadingEl.style.display = 'none';
        isWaitingForAnswer = false;
      }
    }

    function checkAnswer(userAnswer) {
      isWaitingForAnswer = true;
      answerInput.disabled = true;
      submitBtn.disabled = true;

      // Enkel j칛mf칬relse, case insensitive och trim
      const correct = currentAnswer ? userAnswer.toLowerCase() === currentAnswer : false;

      if (correct) {
        score++;
        feedbackEl.textContent = 'R칛tt svar! 游꿀';
        feedbackEl.style.color = '#2cb67d';
      } else {
        feedbackEl.textContent = `Fel svar. R칛tt svar 칛r: ${currentAnswer || 'ok칛nt'}`;
        feedbackEl.style.color = '#d64545';
      }
      updateScore();

      // Ladda ny fr친ga efter 2 sek
      setTimeout(() => {
        feedbackEl.textContent = '';
        loadNewQuestion();
      }, 2000);
    }
  </script>
</body>
</html>
